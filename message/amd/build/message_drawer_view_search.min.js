define(["jquery","core/custom_interaction_events","core/notification","core/pubsub","core/str","core/templates","core_message/message_repository","core_message/message_drawer_events"],function(a,b,c,d,e,f,g,h){var i=50,j=50,k=3,l={BLOCK_ICON_CONTAINER:'[data-region="block-icon-container"]',CANCEL_SEARCH_BUTTON:'[data-action="cancel-search"]',CONTACTS_CONTAINER:'[data-region="contacts-container"]',CONTACTS_LIST:'[data-region="contacts-container"] [data-region="list"]',EMPTY_MESSAGE_CONTAINER:'[data-region="empty-message-container"]',LIST:'[data-region="list"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',LOADING_PLACEHOLDER:'[data-region="loading-placeholder"]',MESSAGES_LIST:'[data-region="messages-container"] [data-region="list"]',MESSAGES_CONTAINER:'[data-region="messages-container"]',NON_CONTACTS_CONTAINER:'[data-region="non-contacts-container"]',NON_CONTACTS_LIST:'[data-region="non-contacts-container"] [data-region="list"]',SEARCH_ICON_CONTAINER:'[data-region="search-icon-container"]',SEARCH_ACTION:'[data-action="search"]',SEARCH_INPUT:'[data-region="search-input"]',SEARCH_RESULTS_CONTAINER:'[data-region="search-results-container"]',LOAD_MORE_USERS:'[data-action="load-more-users"]',LOAD_MORE_MESSAGES:'[data-action="load-more-messages"]',BUTTON_TEXT:'[data-region="button-text"]',NO_RESULTS_CONTAINTER:'[data-region="no-results-container"]'},m={CONTACTS_LIST:"core_message/message_drawer_contacts_list",NON_CONTACTS_LIST:"core_message/message_drawer_non_contacts_list",MESSAGES_LIST:"core_message/message_drawer_messages_list"},n=function(a){return a.attr("data-user-id")},o=function(a){return a.find(l.EMPTY_MESSAGE_CONTAINER)},p=function(a){return a.find(l.LOADING_ICON_CONTAINER)},q=function(a){return a.find(l.LOADING_PLACEHOLDER)},r=function(a){return a.find(l.SEARCH_ICON_CONTAINER)},s=function(a){return a.find(l.SEARCH_INPUT)},t=function(a){return a.find(l.SEARCH_RESULTS_CONTAINER)},u=function(a){return a.find(l.CONTACTS_CONTAINER)},v=function(a){return a.find(l.NON_CONTACTS_CONTAINER)},w=function(a){return a.find(l.MESSAGES_CONTAINER)},x=function(a){o(a).removeClass("hidden")},y=function(a){o(a).addClass("hidden")},z=function(a){p(a).removeClass("hidden")},A=function(a){p(a).addClass("hidden")},B=function(a){q(a).removeClass("hidden")},C=function(a){q(a).addClass("hidden")},D=function(a){r(a).removeClass("hidden")},E=function(a){r(a).addClass("hidden")},F=function(a){t(a).removeClass("hidden")},G=function(a){t(a).addClass("hidden")},H=function(a){s(a).prop("disabled",!0)},I=function(a){s(a).prop("disabled",!1)},J=function(a){s(a).val("")},K=function(a){a.find(l.CONTACTS_LIST).empty(),a.find(l.NON_CONTACTS_LIST).empty(),a.find(l.MESSAGES_LIST).empty(),a.find(l.NO_RESULTS_CONTAINTER).addClass("hidden"),P(a),T(a)},L=function(a,b){E(a),y(b),G(b),z(a),B(b),H(a)},M=function(a,b){D(a),y(b),F(b),A(a),C(b),I(a)},N=function(a){var b=a.find(l.LOAD_MORE_USERS);b.prop("disabled",!0),b.find(l.BUTTON_TEXT).addClass("hidden"),b.find(l.LOADING_ICON_CONTAINER).removeClass("hidden")},O=function(a){var b=a.find(l.LOAD_MORE_USERS);b.prop("disabled",!1),b.find(l.BUTTON_TEXT).removeClass("hidden"),b.find(l.LOADING_ICON_CONTAINER).addClass("hidden")},P=function(a){a.find(l.LOAD_MORE_USERS).removeClass("hidden")},Q=function(a){a.find(l.LOAD_MORE_USERS).addClass("hidden")},R=function(a){var b=a.find(l.LOAD_MORE_MESSAGES);b.prop("disabled",!0),b.find(l.BUTTON_TEXT).addClass("hidden"),b.find(l.LOADING_ICON_CONTAINER).removeClass("hidden")},S=function(a){var b=a.find(l.LOAD_MORE_MESSAGES);b.prop("disabled",!1),b.find(l.BUTTON_TEXT).removeClass("hidden"),b.find(l.LOADING_ICON_CONTAINER).addClass("hidden")},T=function(a){a.find(l.LOAD_MORE_MESSAGES).removeClass("hidden")},U=function(a){a.find(l.LOAD_MORE_MESSAGES).addClass("hidden")},V=function(a,b){return a.find('[data-contact-user-id="'+b+'"]')},W=function(a,b){var c=v(a),d=V(c,b.userid);if(d.length){d.remove();var e=u(a);e.removeClass("hidden"),e.find(l.LIST).append(d)}c.find(l.LIST).children().length||c.addClass("hidden")},X=function(a,b){var c=u(a),d=V(c,b);if(d.length){d.remove();var e=v(a);e.removeClass("hidden"),e.find(l.LIST).append(d)}c.find(l.LIST).children().length||c.addClass("hidden")},Y=function(a,b){var c=V(a,b);c.length&&c.find(l.BLOCK_ICON_CONTAINER).removeClass("hidden")},Z=function(a,b){var c=V(a,b);c.length&&c.find(l.BLOCK_ICON_CONTAINER).addClass("hidden")},$=function(b,c){var d=u(b),e=d.find(l.LIST);if(c.length||e.children().length)return f.render(m.CONTACTS_LIST,{contacts:c}).then(function(a){return e.append(a),a});var g=d.find(l.NO_RESULTS_CONTAINTER);return g.removeClass("hidden"),a.Deferred().resolve("").promise()},_=function(b,c){var d=v(b),e=d.find(l.LIST);if(c.length||e.children().length)return f.render(m.NON_CONTACTS_LIST,{noncontacts:c}).then(function(a){return e.append(a),a});var g=d.find(l.NO_RESULTS_CONTAINTER);return g.removeClass("hidden"),a.Deferred().resolve("").promise()},aa=function(b,c){var d=w(b),e=d.find(l.LIST);if(c.length||e.children().length)return f.render(m.MESSAGES_LIST,{messages:c}).then(function(a){return e.append(a),a});var g=d.find(l.NO_RESULTS_CONTAINTER);return g.removeClass("hidden"),a.Deferred().resolve("").promise()},ba=function(b,c,d,e,f){var h=!1;return N(b),g.searchUsers(c,d,e+1,f).then(function(a){var b=a.contacts,c=a.noncontacts;return b.length<=e&&c.length<=e?(h=!0,{contacts:b,noncontacts:c}):{contacts:b.slice(0,e),noncontacts:c.slice(0,e)}}).then(function(c){return a.when($(b,c.contacts),_(b,c.noncontacts))}).then(function(){O(b),h&&Q(b)})["catch"](function(a){throw O(b),a})},ca=function(a,b,c,d,e){var f=!1;return R(a),g.searchMessages(b,c,d+1,e).then(function(a){var b=a.contacts;return b.length<=d?(f=!0,b):b.slice(0,d)}).then(function(b){return aa(a,b)}).then(function(){S(a),f&&U(a)})["catch"](function(b){throw S(a),b})},da=function(b,c,d,e,f,g,h){var i=n(c);return L(b,c),K(c),a.when(ba(c,i,d,e,f),ca(c,i,d,g,h)).then(function(){M(b,c)})},ea=function(a,e){var f=n(e),g=s(a),m="",o=0,p=0,q=function(b,d){m=g.val().trim(),""!==m&&(o=0,p=0,da(a,e,m,k,p,i,o).then(function(){g.focus(),p+=k,o+=i})["catch"](c.exception)),d.originalEvent.preventDefault()};b.define(g,[b.events.enter]),b.define(a,[b.events.activate]),b.define(e,[b.events.activate]),g.on(b.events.enter,q),a.on(b.events.activate,l.SEARCH_ACTION,q),e.on(b.events.activate,l.LOAD_MORE_MESSAGES,function(a,b){""!==m&&ca(e,f,m,i,o).then(function(){o+=i})["catch"](c.exception),b.originalEvent.preventDefault()}),e.on(b.events.activate,l.LOAD_MORE_USERS,function(a,b){""!==m&&ba(e,f,m,j,p).then(function(){p+=j})["catch"](c.exception),b.originalEvent.preventDefault()}),a.on(b.events.activate,l.CANCEL_SEARCH_BUTTON,function(){J(a),x(e),D(a),G(e),A(a),C(e),p=0,o=0}),d.subscribe(h.CONTACT_ADDED,function(a){W(e,a)}),d.subscribe(h.CONTACT_REMOVED,function(a){X(e,a)}),d.subscribe(h.CONTACT_BLOCKED,function(a){Y(e,a)}),d.subscribe(h.CONTACT_UNBLOCKED,function(a){Z(e,a)})},fa=function(b,c){c.attr("data-init")||(ea(b,c),c.attr("data-init",!0));var d=s(b);return d.focus(),a.Deferred().resolve().promise()},ga=function(a){var b=s(a),c=b.val().trim();return e.get_string("messagedrawerviewsearch","core_message",c)};return{show:fa,description:ga}});